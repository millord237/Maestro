# Refactor Task 44: src/main/web-server/routes/wsRoute.ts

## Summary

This 217-line file is well-structured and focused on WebSocket route setup and connection handling. It follows good patterns like dependency injection via callbacks and proper delegation to message handlers. The main issues found are type duplication (LiveSessionInfo, CustomAICommand defined in 4 files) and a session enrichment pattern duplicated across 3-4 locations. No `any` types or deprecated patterns found. One empty catch block for JSON parse errors is acceptable for message validation.

## Dead Code

None found.

All exports are actively used:
- `WsRoute` class: Instantiated in `src/main/web-server.ts:283`
- `LiveSessionInfo`: Re-exported via index.ts as `WsLiveSessionInfo`
- `CustomAICommand`: Re-exported via index.ts as `WsCustomAICommand`
- `WsSessionData`: Used in callbacks interface
- `WsRouteCallbacks`: Used by `setCallbacks()` method

## Deprecated Patterns

None found.

The WebSocket route uses modern Fastify WebSocket patterns with proper connection handling via `@fastify/websocket`. The callback-based dependency injection is a clean modern pattern.

## Duplication

### Type Definitions (High Priority)

1. **`LiveSessionInfo` interface duplicated in 4 files:**
   - `src/main/web-server/routes/wsRoute.ts:30-34` (this file)
   - `src/main/web-server/handlers/messageHandlers.ts:63-67`
   - `src/main/web-server/routes/apiRoutes.ts:109-113`
   - `src/main/web-server.ts:33-37`

   All 4 definitions are identical. The routes/index.ts attempts to manage this with aliases (`WsLiveSessionInfo`, `ApiLiveSessionInfo`) but should consolidate to a single shared location.

2. **`CustomAICommand` interface duplicated in 4+ files:**
   - `src/main/web-server/routes/wsRoute.ts:39-44`
   - `src/main/web-server.ts:190-194`
   - `src/main/web-server/services/broadcastService.ts`
   - `src/renderer/types/index.ts`

3. **`WsSessionData` interface with `[key: string]: unknown` index signature:**
   - Nearly identical structure to `getSessions` return type in `messageHandlers.ts:81-90`
   - Both have the same base fields and use `[key: string]: unknown` for extensibility

### Session Enrichment Pattern (Medium Priority)

The session enrichment logic is duplicated in 3-4 locations (~10 lines each):
- `wsRoute.ts:134-142` - Initial session sync
- `apiRoutes.ts:194-200` - GET /sessions endpoint
- `apiRoutes.ts:241-246` - GET /sessions/:sessionId endpoint
- `messageHandlers.ts:387-393` - get_sessions message handler

Pattern duplicated:
```typescript
const liveInfo = this.callbacks.getLiveSessionInfo?.(s.id);
return {
  ...s,
  agentSessionId: liveInfo?.agentSessionId || s.agentSessionId,
  liveEnabledAt: liveInfo?.enabledAt,
  isLive: this.callbacks.isSessionLive?.(s.id) || false,
};
```

## Code Smells

### Repetitive WebSocket Send Pattern (Low Priority)

6 instances of `connection.socket.send(JSON.stringify(...))` in `registerRoute()`:
- Lines 123-129: Connection confirmation
- Lines 143-147: Sessions list
- Lines 154-158: Theme
- Lines 165-169: Custom commands
- Lines 179-184: AutoRun state (inside forEach loop)
- Lines 195-198: Error response

Could extract a helper: `sendMessage(socket, type, payload)`.

### Empty Catch Block (Acceptable)

```typescript
} catch {
  connection.socket.send(JSON.stringify({
    type: 'error',
    message: 'Invalid message format',
  }));
}
```

This is actually good error handling - it catches JSON parse errors and sends a meaningful error response. The pattern is intentional for client message validation.

### Minor: Inconsistent Logging Detail

- Connection logged with session info: `logger.info(`Client connected: ${clientId} (session: ${sessionId || 'dashboard'})`, LOG_CONTEXT);`
- Disconnection lacks session info: `logger.info(`Client disconnected: ${clientId}`, LOG_CONTEXT);`

Consider storing sessionId with client to log it on disconnect.

## Type Safety Issues

### Weak Index Signature (Low Priority)

```typescript
export interface WsSessionData {
  // ... specific fields ...
  [key: string]: unknown;
}
```

Line 57: The `[key: string]: unknown` index signature allows arbitrary properties but provides no type safety for them. Should either:
1. Remove if not needed (prefer explicit fields)
2. Or use discriminated unions for known session types

### WebClientMessage as Type Parameter (Low Priority)

Line 192: `const data = JSON.parse(message.toString()) as WebClientMessage;`

The `as` cast is unsafe if the parsed JSON doesn't match the interface. However, this is immediately passed to the message handler which validates the structure, so the risk is contained.

## Recommended Refactoring

1. **Consolidate LiveSessionInfo to shared location** (High Priority)
   - Create `src/main/web-server/types.ts` with shared interfaces
   - Export from single location, import everywhere
   - Remove 3 duplicate definitions
   - Effort: 15 min | Impact: Reduces maintenance burden

2. **Consolidate CustomAICommand to shared location** (High Priority)
   - Add to `src/main/web-server/types.ts`
   - Update 4 import locations
   - Effort: 15 min | Impact: Reduces drift risk

3. **Extract session enrichment helper** (Medium Priority)
   - Create `enrichSessionWithLiveInfo(session, callbacks)` utility
   - Replace 4 duplicate patterns
   - Effort: 20 min | Impact: Single source of truth

4. **Extract WebSocket send helper** (Low Priority)
   - Create `sendJsonMessage(socket, type, payload)`
   - Reduces boilerplate in 6 locations
   - Effort: 10 min | Impact: Cleaner code

5. **Add unit tests** (Medium Priority)
   - No test file exists for wsRoute.ts
   - Should test: connection flow, initial state sync, message delegation, error handling
   - Effort: 1 hour | Impact: Safety for refactoring

6. **Add sessionId to disconnect logs** (Low Priority)
   - Store subscribedSessionId reference for disconnect logging
   - Effort: 5 min | Impact: Better debugging

7. **Strengthen WsSessionData type** (Low Priority)
   - Remove `[key: string]: unknown` if not used
   - Or document why extensibility is needed
   - Effort: 10 min | Impact: Better type safety

## Estimated Impact

**Risk Level: Low**
- This file is isolated with clean callback interfaces
- Changes are additive (consolidating types) not behavioral
- No existing tests to maintain/update

**Testing Considerations:**
- Should add unit tests before major refactoring
- Integration test for WebSocket handshake flow
- Mock socket for message validation testing

**Dependencies:**
- Changes to shared types affect: apiRoutes.ts, messageHandlers.ts, broadcastService.ts, web-server.ts
- Session enrichment helper would be used by 3-4 files
