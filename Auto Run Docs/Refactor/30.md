# Refactor Task 30: src/main/storage/claude-session-storage.ts

## Summary

Claude session storage implementation is well-structured at 932 lines with good documentation and a clean class-based design. The file provides session listing, pagination, search, message reading, and message deletion functionality. Main issues are significant duplication with the deprecated `claude.ts` IPC handlers and type definitions duplicated across 4+ files.

## Dead Code

- **None found** - All public methods are actively used through the `AgentSessionStorage` interface and called via `agentSessions` IPC handlers

## Deprecated Patterns

- **None found** - Uses modern async/await, ES modules, and proper TypeScript patterns. The class itself is the modern replacement for deprecated `claude.ts` handlers.

## Duplication

1. **`extractTextFromContent()` function duplicated 3 times** (`claude-session-storage.ts:57-69`, `claude.ts:131-143`, `codex-session-storage.ts:99-110`)
   - All implementations filter array for `type === 'text'` and join text parts
   - Should be extracted to shared utility

2. **`calculateCost()` function duplicated 6+ times across codebase** (`claude-session-storage.ts:74-86`, `claude.ts:240-244, 436-439, 548-551, 766-769`, `agentSessions.ts:98-102`)
   - Identical formula repeated: `(tokens / 1_000_000) * PRICING.X_PER_MILLION`
   - 24 instances of the `1_000_000` magic number with pricing constants
   - Should have single `calculateClaudeCost()` function in `src/main/constants.ts`

3. **`ClaudeSessionOriginsData` interface duplicated 4 times** (`claude-session-storage.ts:49-51`, `claude.ts:115-117`, `index.ts:211-215`, `handlers/index.ts:68-72`)
   - All define `origins: Record<string, Record<string, ...>>`
   - Should import from single source (`claude-session-storage.ts`)

4. **`parseSessionFile()` logic duplicated** (`claude-session-storage.ts:91-206` vs `claude.ts:153-295`)
   - Nearly identical 100+ line implementations for parsing JSONL session files
   - Both scan for first message, extract tokens via regex, calculate timestamps
   - The `claude.ts` version is legacy and should be removed

5. **Session search logic duplicated** (`claude-session-storage.ts:481-619` vs `claude.ts` search implementation)
   - Similar pattern matching and search mode handling

## Code Smells

1. **`parseSessionFile()` is 116 lines** (`claude-session-storage.ts:91-206`)
   - Could be split into smaller helpers: `extractFirstMessage()`, `extractTokenCounts()`, `extractTimestamps()`

2. **`searchSessions()` is 139 lines** (`claude-session-storage.ts:481-619`)
   - Complex switch statement could be simplified with strategy pattern
   - Match preview extraction duplicated 3 times within the method (lines 538-544, 551-557, 564-570)

3. **`deleteMessagePair()` is 109 lines** (`claude-session-storage.ts:626-794`)
   - Complex nested logic for finding messages, collecting tool_use IDs, and cleaning up orphaned tool_results
   - Could benefit from helper functions for each responsibility

4. **Silent catch blocks with `// Skip malformed lines`** (lines 132, 134, 177, 461, 573, 613, 651)
   - 7 empty catch blocks that silently swallow parsing errors
   - Should at minimum count errors and log summary at end

## Type Safety Issues

1. **`content: unknown` parameter in `extractTextFromContent()`** (`claude-session-storage.ts:57`)
   - Uses loose typing for message content
   - Could define `ClaudeMessageContent` type as `string | Array<{ type: string; text?: string }>`

2. **`entry: unknown` in `parsedLines` array** (`claude-session-storage.ts:639`)
   - `deleteMessagePair()` uses `unknown` for parsed entries
   - Should define proper `SessionEntry` interface

3. **Inline cast `as AgentSessionOrigin | undefined`** (`claude-session-storage.ts:264`)
   - Safe cast in context, but type narrowing would be cleaner

4. **`toolUse?: unknown` in `SessionMessage` interface** (from `agent-session-storage.ts:42`, used here)
   - Weak typing inherited from parent interface
   - Claude tool_use has known structure that could be properly typed

5. **Inline type definitions in `deleteMessagePair()`** (lines 660-663, 700-703, 729-732)
   - Anonymous types repeated: `{ type?: string; message?: { content?: unknown } }`
   - Should define once as named interface

## Recommended Refactoring

1. **[High Priority] Extract cost calculation to shared utility**
   - Create `calculateClaudeCost()` in `src/main/constants.ts`
   - Replace 6+ duplicated implementations across codebase
   - Eliminates 24 instances of magic `1_000_000` number

2. **[High Priority] Extract text content extraction to shared utility**
   - Create `extractMessageText()` in new `src/main/utils/messageUtils.ts`
   - Used by claude-session-storage, codex-session-storage, claude.ts handlers

3. **[Medium Priority] Consolidate `ClaudeSessionOriginsData` type**
   - Keep definition in `claude-session-storage.ts` (already exported)
   - Remove duplicates from `claude.ts`, `index.ts`, `handlers/index.ts`

4. **[Medium Priority] Remove deprecated `claude.ts` handlers**
   - All functionality now implemented in `ClaudeSessionStorage` class
   - `claude.ts` duplicates session parsing, searching, cost calculation
   - Migration path: update renderer call sites to use `agentSessions:*` API

5. **[Low Priority] Split large methods**
   - Extract `parseSessionFile()` helpers: token extraction, message scanning
   - Extract `searchSessions()` match preview generation to helper
   - Extract `deleteMessagePair()` tool cleanup to separate method

6. **[Low Priority] Define proper content types**
   - Create `ClaudeMessageContent` and `ClaudeSessionEntry` interfaces
   - Replace `unknown` types in message parsing

7. **[Low Priority] Log silent parse errors**
   - Add error counting in catch blocks
   - Log summary of skipped malformed lines after processing

## Estimated Impact

- **Risk Level:** Low to Medium
- **Testing Considerations:**
  - Existing unit tests in `agent-session-storage.test.ts` cover basic class instantiation
  - Need integration tests with real Claude session files for parsing logic
  - Cost calculation changes need regression testing for billing accuracy
- **Breaking Changes:** None if refactoring is internal; API remains stable through interface
