# Refactor Task 51: `src/renderer/App.tsx`

## Summary

This file is the primary React application component at **6,833 lines** - a severe **God Component** that is **22x larger** than the recommended 300-line guideline. While significant refactoring has already occurred (49 custom hooks exist in `src/renderer/hooks/`), the component still contains:
- Massive amounts of state management (109 `useState` calls)
- Complex effects (32 `useEffect` hooks)
- Inline event handlers that should be extracted
- Several `any` types and weak typing patterns
- Duplicated logic that could be consolidated

The file has been partially refactored with hooks like `useAgentExecution`, `useBatchProcessor`, `useSettings`, etc., but significant opportunities remain.

## Dead Code

### Identified Dead/Potentially Unused Code

1. **`aiLogs` property on Session (deprecated)** - Lines 3344, 3473
   - Comment explicitly states: `aiLogs: [], // Deprecated - logs are now in aiTabs`
   - This property is initialized but should be removed entirely

2. **Duplicate `__maestroDebug` registration** - Lines 688 and 1657-1672
   - The debug object is registered twice in different useEffects
   - The first registration (line 688) appears to be orphaned context

3. **`cyclePositionRef`** - Referenced but navigation logic is complex
   - Used for session cycling but the cycle position tracking logic is intricate and may have edge cases that are never reached

4. **Commented-out/empty TODO blocks** - Line 3387
   ```typescript
   // TODO: Show error to user
   ```
   Should either be implemented or removed

## Deprecated Patterns

### Identified Deprecated Patterns

1. **Session-level `agentSessionId`** - Used throughout but deprecated
   - Code comments repeatedly mention "deprecated session-level one" when discussing `agentSessionId`
   - Should be fully migrated to tab-level `agentSessionId` and old pattern removed

2. **`aiLogs` array on Session** - Lines 3344, 3473
   - Explicitly marked deprecated, logs now stored in `aiTabs[].logs`
   - Property still exists and is initialized on new sessions

3. **Legacy Claude API references** - Line 5987
   ```typescript
   window.maestro.claude.deleteMessagePair(...)
   ```
   - Uses old `window.maestro.claude` API instead of unified `window.maestro.agentSessions`

4. **Multiple flash notification systems** - Lines 6800-6825
   - Two separate flash notification implementations (`flashNotification` and `successFlashNotification`)
   - Should be consolidated into a single unified notification system

## Duplication

### Identified Duplicated Logic

1. **Session state update pattern** - Appears 50+ times
   ```typescript
   setSessions(prev => prev.map(s => {
     if (s.id !== sessionId) return s;
     return { ...s, /* updates */ };
   }));
   ```
   - Should extract a `updateSession(sessionId, updates)` helper function

2. **Active tab retrieval pattern** - Appears 30+ times
   ```typescript
   const activeTab = getActiveTab(activeSession);
   if (!activeTab) { console.error('...'); return; }
   ```
   - Should be a single hook or utility that handles the null check

3. **Tab state update pattern** - Appears 20+ times
   ```typescript
   aiTabs: s.aiTabs.map(tab =>
     tab.id === targetTabId ? { ...tab, /* updates */ } : tab
   )
   ```
   - Should extract an `updateTab(sessionId, tabId, updates)` helper

4. **Git branch fetching** - Lines 4103-4112, 4157-4165
   ```typescript
   if (session.isGitRepo) {
     try {
       const status = await gitService.getStatus(session.cwd);
       gitBranch = status.branch;
     } catch { /* Ignore git errors */ }
   }
   ```
   - Duplicated in `processQueuedItem` for both message and command processing

5. **System prompt substitution and prepending** - Lines 4099-4121, 4172-4184
   - Nearly identical logic for prepending Maestro system prompt to messages and commands
   - Should be extracted to a single function

6. **Group chat participant lookup** - Lines 5796-5813
   - Same lookup pattern repeated 4 times within close proximity for participants, states, paths, etc.

7. **Queue processing state updates** - Lines 4316-4376, 4438-4505
   - Very similar logic for handling queue after interrupt vs. after kill
   - Nearly 90+ duplicated lines

8. **New session creation** - Lines 3268-3389, 3395-3507
   - `createNewSession` and `handleWizardLaunchSession` have substantial overlap
   - Session object creation is ~80% identical

## Code Smells

### Critical Code Smells

1. **God Component** - 6,833 lines
   - **CRITICAL**: File is 22x larger than recommended 300-line maximum
   - Contains 109 `useState` calls
   - Contains 32 `useEffect` hooks
   - Contains 44 `useCallback` hooks
   - Should be split into multiple smaller components/hooks

2. **Deep nesting** - Multiple locations with 4+ levels
   - `processQueuedItem` function (lines 4049-4278) has nested try/catch with multiple conditional branches
   - `handleInterrupt` function (lines 4283-4409) has deeply nested conditionals

3. **Overly complex functions** - Several exceed 100 lines
   - `processQueuedItem`: ~230 lines (4049-4278)
   - `handleInterrupt`: ~127 lines (4283-4409)
   - `cycleSession`: ~109 lines (3097-3205)
   - `handleWizardLaunchSession`: ~113 lines (3395-3507)
   - `onDeleteLog` callback: ~85 lines inline (5930-6014)

4. **Magic numbers** - Various locations
   - Line 3353: `port: 3000 + Math.floor(Math.random() * 100)` - magic port range
   - Line 3359: `fileTreeAutoRefreshInterval: 180` - magic refresh interval
   - Line 3384: `setTimeout(() => inputRef.current?.focus(), 50)` - magic delay
   - Line 3784: `setTimeout(() => inputRef.current?.focus(), 0)` - different magic delay

5. **Inline callback complexity** - Lines 5607-5636, 5930-6014
   - Complex multi-step logic defined inline in JSX props
   - Should be extracted to named functions

6. **Massive JSX return** - Lines 5150-6831 (~1,700 lines of JSX)
   - Single return statement spanning nearly 1,700 lines
   - Many conditionally rendered components could be extracted

7. **Too many props passed to child components** - Lines 5671-5748
   - `SessionList` receives 60+ props
   - Should consider context or composition patterns

8. **State synchronization complexity** - Lines 1896-1939
   - Complex useEffect for syncing local AI input with tab's persisted value
   - Multiple refs and effects for tracking previous values

## Type Safety Issues

### Identified Type Problems

1. **Explicit `any` types** - 6 instances found
   - Line 922: `(g: any) => g.id === currentSession.groupId`
   - Line 4243: `catch (error: any)` - should use `unknown` and narrow
   - Line 4825: `async (node: any, path: string)` - needs proper FileNode type

2. **`as any` casts** - 3 instances
   - Lines 688, 1657, 1672: `(window as any).__maestroDebug`
   - Should use proper module augmentation for window type

3. **Implicit any in catch blocks** - Line 4481 and others
   - Multiple catch blocks don't type the error parameter

4. **Non-null assertions** - Not prevalent but present in some places
   - Line 5544: `groupChats.find(c => c.id === activeGroupChatId)!`
   - Should use conditional rendering or proper null handling

5. **Weak type for `onDeleteLog` callback** - Lines 5930-6014
   - Returns `number | null` but logic is complex enough to warrant a dedicated type

6. **Missing return types** on many callback functions
   - Most `useCallback` hooks don't specify return type explicitly

## Recommended Refactoring

### High Priority

1. **Extract remaining App state to hooks** (High)
   - Create `useGroupChatState` hook for all group chat related state (15+ useState calls)
   - Create `useAutoRunState` hook for auto-run document/editor state
   - Create `useModalState` hook for 10+ modal open/close states
   - Create `useUIState` hook for UI focus, sidebar, panel states

2. **Extract inline handler callbacks to hooks** (High)
   - `processQueuedItem` → `useQueueProcessor` hook
   - `handleInterrupt` → `useInterruptHandler` hook
   - `cycleSession` → `useCycleSession` hook
   - `createNewSession` → consolidate with `handleWizardLaunchSession`

3. **Create session/tab update utilities** (High)
   ```typescript
   const { updateSession, updateTab, updateActiveTab } = useSessionUpdater();
   ```
   - Eliminate 50+ repeated `setSessions(prev => prev.map(...))` patterns

4. **Split JSX into smaller components** (High)
   - Extract flash notifications to `<FlashNotifications />`
   - Extract modal rendering to `<AppModals />`
   - Extract main workspace area logic to `<WorkspaceArea />`

### Medium Priority

5. **Remove deprecated code** (Medium)
   - Remove `aiLogs` property from Session type and all initializations
   - Complete migration from session-level to tab-level `agentSessionId`
   - Remove duplicate `__maestroDebug` registration

6. **Consolidate flash notifications** (Medium)
   - Merge `flashNotification` and `successFlashNotification` into unified system
   - Consider using toast system for all notifications

7. **Fix type safety issues** (Medium)
   - Replace all `any` with proper types
   - Add explicit return types to all callbacks
   - Use proper window type augmentation for debug utilities

8. **Extract Git branch fetching** (Medium)
   - Create `useGitBranch(session)` hook for consistent branch retrieval
   - Eliminate duplication in `processQueuedItem`

### Low Priority

9. **Define constants for magic numbers** (Low)
   ```typescript
   const PORTS = { BASE: 3000, RANGE: 100 };
   const TIMEOUTS = { FOCUS_DELAY: 50, FILE_TREE_REFRESH: 180 };
   ```

10. **Reduce prop drilling** (Low)
    - Consider React Context for frequently passed props
    - SessionList receiving 60+ props is a code smell

## Estimated Impact

### Risk Level: **High**

- App.tsx is the core component - changes affect entire application
- 49 existing hooks already extracted - further extraction requires careful dependency management
- Large test surface area needed for any refactoring
- State synchronization between hooks/components is complex

### Testing Considerations

1. **Manual testing required** for all UI interactions
2. **Integration tests** needed for session/tab state management
3. **Snapshot tests** for modal rendering
4. **Hook isolation tests** for extracted hooks
5. **E2E tests** for critical flows (new session, wizard, batch processing)

### Incremental Approach Recommended

1. Start with extracting pure utility functions (no state dependencies)
2. Extract modal state to dedicated hook
3. Extract group chat state to dedicated hook
4. Consolidate session update patterns
5. Extract remaining complex handlers
6. Clean up deprecated code last

This refactoring should be done incrementally over multiple PRs to minimize risk and ensure stability.
