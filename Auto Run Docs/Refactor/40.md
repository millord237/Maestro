# Refactor Task 40: `src/main/utils/cliDetection.ts`

## Summary

The file is a small, well-structured 69-line utility for detecting cloudflared CLI installation. It has excellent test coverage (457 lines). Key findings: `clearCloudflaredCache()` is only used in tests (dead code in production); major PATH expansion logic duplication across 4 locations; `which`/`where` pattern duplicated across 5 locations. No type safety issues found.

## Dead Code

1. **`clearCloudflaredCache()` - only used in tests** (`cliDetection.ts:66-68`)
   - Exported function is never imported or called in production code
   - Only used in test file for test isolation
   - Could be marked with `@internal` or `@testOnly` JSDoc to document intent

2. **`getExpandedEnv()` - private function, cannot be dead, but is duplicated** (`cliDetection.ts:11-39`)
   - While the function itself is used, it's duplicated elsewhere (see Duplication below)

## Deprecated Patterns

None found. The code uses modern async/await patterns and proper module exports.

## Duplication

1. **Major: PATH expansion logic duplicated in 4 locations** (~30 lines each, ~120 lines total duplication)
   - `src/main/utils/cliDetection.ts:11-39` - `getExpandedEnv()`
   - `src/main/agent-detector.ts:303-335` - `private getExpandedEnv()`
   - `src/cli/services/agent-spawner.ts:40-67` - `getExpandedPath()`
   - `src/main/process-manager.ts:384-387` - inline PATH expansion (simpler version)

   All four share the same list of paths:
   - `/opt/homebrew/bin`, `/opt/homebrew/sbin`
   - `/usr/local/bin`, `/usr/local/sbin`
   - `${home}/.local/bin`, `${home}/bin`
   - `/usr/bin`, `/bin`, `/usr/sbin`, `/sbin`

   Differences:
   - `agent-detector.ts` includes `${home}/.npm-global/bin` and `${home}/.claude/local`
   - `agent-spawner.ts` also includes `${home}/.npm-global/bin` and `${home}/.claude/local`
   - `cliDetection.ts` is missing these two paths

2. **`which`/`where` platform detection pattern duplicated in 5 locations** (~5 lines each)
   - `src/main/utils/cliDetection.ts:48` - cloudflared detection
   - `src/main/utils/shellDetector.ts:39` - shell detection
   - `src/main/agent-detector.ts:343` - agent binary detection
   - `src/cli/services/agent-spawner.ts:97` - Claude CLI detection
   - `src/main/agent-detector.ts:432` - model discovery detection

   Pattern: `const command = process.platform === 'win32' ? 'where' : 'which';`

3. **Binary path extraction pattern duplicated**
   - `result.stdout.trim().split('\n')[0]` appears in:
     - `cliDetection.ts:54`
     - `shellDetector.ts:47`
     - `agent-detector.ts:352`
     - `agent-spawner.ts:104`

## Code Smells

1. **`clearCloudflaredCache` only clears one of two caches** (`cliDetection.ts:66-68`)
   - Function clears `cloudflaredInstalledCache` but NOT `cloudflaredPathCache`
   - This is documented as a quirk in tests (line 239) but creates confusing behavior
   - A user calling `clearCloudflaredCache()` might expect both caches to be cleared

2. **Inconsistent path list between implementations**
   - `agent-detector.ts` and `agent-spawner.ts` include `${home}/.npm-global/bin` and `${home}/.claude/local`
   - `cliDetection.ts` is missing these paths
   - This means cloudflared detection might fail if installed in these locations

3. **Magic path strings scattered across codebase**
   - Path strings like `/opt/homebrew/bin` appear 30+ times in production and test code
   - Should be centralized in a shared constant

## Type Safety Issues

None found. The file has excellent type safety:
- All functions have proper return type annotations
- Uses `NodeJS.ProcessEnv` for environment
- Module-level variables are properly typed (`boolean | null`, `string | null`)

## Recommended Refactoring

1. **High: Create shared `pathUtils.ts` with `getExpandedEnv()` function**
   - Priority: High
   - Move to `src/shared/pathUtils.ts` or `src/main/utils/pathUtils.ts`
   - All 4 locations can import from the shared module
   - Include ALL paths (merge the superset from agent-detector/agent-spawner)

2. **Medium: Create shared `binaryDetection.ts` utility**
   - Priority: Medium
   - Extract `which`/`where` pattern into a reusable function
   - Signature: `checkBinaryExists(binaryName: string): Promise<{exists: boolean, path?: string}>`
   - Both `cliDetection.ts` and `shellDetector.ts` can use this

3. **Low: Document or rename `clearCloudflaredCache()`**
   - Priority: Low
   - Either rename to `clearCloudflaredInstalledCache()` for clarity
   - Or fix to also clear `cloudflaredPathCache`
   - Or add JSDoc documenting the current behavior

4. **Low: Add missing paths to cliDetection.ts**
   - Priority: Low
   - Add `${home}/.npm-global/bin` and `${home}/.claude/local` for consistency
   - Or, refactor to use shared `getExpandedEnv()` (per item 1)

5. **Low: Mark `clearCloudflaredCache` as test-only**
   - Priority: Low
   - Add `@internal` or `@testOnly` JSDoc to document this is for testing
   - Or move to a separate `cliDetection.test-helpers.ts` file

6. **Low: Create PATH constants**
   - Priority: Low
   - Extract common paths to shared constants
   - `HOMEBREW_PATHS`, `SYSTEM_PATHS`, `USER_PATHS`

## Estimated Impact

- **Risk Level:** Low
- **Testing Considerations:**
  - Existing 457-line test file provides excellent coverage
  - Refactoring to shared utilities will require test updates in multiple files
  - PATH expansion changes should be tested on both macOS and Linux
- **Dependencies:**
  - `tunnel-manager.ts` imports `isCloudflaredInstalled` and `getCloudflaredPath`
  - `system.ts` IPC handler imports `isCloudflaredInstalled`
  - Changes to path expansion logic affects cloudflared detection behavior
