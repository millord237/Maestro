# Refactor Task 45: `src/main/web-server/services/broadcastService.ts`

## Summary
This 316-line broadcast service module is well-structured with excellent test coverage (497 lines). The primary issues are type duplications across multiple locations in the codebase, and repetitive timestamp injection patterns that could be simplified.

## Dead Code
None found.
- All exported interfaces (`WebClientInfo`, `CustomAICommand`, `AITabData`, `SessionBroadcastData`, `AutoRunState`, `CliActivity`) are actively used
- All broadcast methods are used by web-server.ts
- Excellent test coverage validates all methods are functional

## Deprecated Patterns
None found.
- Uses modern WebSocket patterns from 'ws' library
- Clean dependency injection pattern for client callback
- Well-documented JSDoc comments

## Duplication

### 1. `AITabData` interface - 4 definitions
- `src/main/web-server/services/broadcastService.ts:52` - canonical for broadcast
- `src/main/web-server.ts:91` - duplicate
- `src/main/web-server/routes/apiRoutes.ts:48` - duplicate
- `src/web/hooks/useWebSocket.ts:37` - web client version

### 2. `CustomAICommand` interface - 5 definitions
- `src/renderer/types/index.ts:507` - canonical (has `isBuiltIn` field)
- `src/main/web-server/services/broadcastService.ts:42` - missing `isBuiltIn`
- `src/main/web-server.ts:190` - missing `isBuiltIn`
- `src/main/web-server/routes/wsRoute.ts:39` - missing `isBuiltIn`
- `ARCHITECTURE.md:541` - documentation version

### 3. `AutoRunState` interface - 2 definitions
- `src/main/web-server/services/broadcastService.ts:89` - canonical
- `src/web/hooks/useWebSocket.ts:85` - duplicate (identical)

### 4. `CliActivity` interface - divergent from shared type
- `src/main/web-server/services/broadcastService.ts:100` - simplified version (3 fields)
- `src/shared/cli-activity.ts:9` - full `CliActivityStatus` (7 fields including `sessionId`, `pid`, `currentTask`, `currentDocument`)

### 5. Timestamp injection pattern - 12 occurrences
Lines 176, 187, 198, 210, 222, 236, 248, 260, 274, 288, 301, 313 all have:
```typescript
timestamp: Date.now(),
```
Could be abstracted into `broadcastToAll` base method.

## Code Smells
None found.
- Methods are appropriately sized (< 15 lines each)
- Clean single-responsibility design
- Good error handling (null checks before broadcast)
- Proper logging with context

## Type Safety Issues

### 1. Broadcast message type looseness
```typescript
broadcastToAll(message: object): void {
```
The `object` type is too broad. Could use a discriminated union of all broadcast message types:
```typescript
type BroadcastMessage =
  | { type: 'session_state_change'; sessionId: string; state: string; ... }
  | { type: 'theme'; theme: Theme; timestamp: number; }
  | ...
```

### 2. Session state as string
```typescript
broadcastSessionStateChange(sessionId: string, state: string, ...
```
The `state` parameter should use the `SessionState` union type: `'idle' | 'busy' | 'error' | 'connecting'`

### 3. `CliActivity` type mismatch
The local `CliActivity` interface is a subset of `CliActivityStatus` from shared, which could cause data loss if the full activity data is passed.

## Recommended Refactoring

1. **High Priority:** Create shared broadcast types file
   - Move `AITabData`, `CustomAICommand`, `AutoRunState` to `src/shared/broadcast-types.ts`
   - Import everywhere instead of duplicating
   - Reduces 5+ duplicate definitions to 1 source

2. **Medium Priority:** Use `CliActivityStatus` from shared
   - Remove local `CliActivity` interface
   - Import `CliActivityStatus` from `src/shared/cli-activity.ts`
   - Ensures consistency with CLI activity tracking

3. **Medium Priority:** Create discriminated union for broadcast messages
   - Define `BroadcastMessageType` union
   - Type-safe message handling in receivers
   - Prevents malformed broadcast messages

4. **Low Priority:** Extract timestamp injection to helper
   - Create `private withTimestamp<T>(message: T): T & { timestamp: number }`
   - Reduces 12 identical patterns to 1

5. **Low Priority:** Type session state properly
   - Import `SessionState` from shared/types.ts
   - Use in `broadcastSessionStateChange` signature

6. **Low Priority:** Add `isBuiltIn` to web CustomAICommand definitions
   - Sync with renderer's canonical definition
   - Prevents bugs if built-in commands are sent to web

7. **Low Priority:** Consider typed broadcast response
   - `broadcastToAll<T extends BroadcastMessage>(message: T)`
   - Compile-time validation of broadcast payloads

## Estimated Impact
- **Risk Level:** Low
- **Testing:** Existing tests (497 lines) provide excellent coverage
- **Migration:** Type consolidation is straightforward
- **Breaking Changes:** None expected - changes are additive/internal
