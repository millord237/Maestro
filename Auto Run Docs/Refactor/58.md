# Refactor Task 58: LayerStackContext.tsx

## Summary

The `LayerStackContext.tsx` file (95 lines) is a well-structured, minimal context provider following modern React patterns. It serves as a thin wrapper around the `useLayerStack` hook, providing global access and Escape key handling. The file has excellent test coverage (800+ lines in test file). Minor issues include one API method used only in tests (`layerCount`), one API method only used in tests (`getLayers`), and a minor type duplication in the related `useModalLayer.ts` hook.

## Dead Code

1. **`getLayers()` API method** - Only used in tests (17 usages), never in production code
   - Definition: `src/renderer/hooks/useLayerStack.ts:165-167`
   - All usages are in test files (`useLayerStack.test.ts`, `LayerStackContext.test.tsx`)
   - Consider removing from public API or documenting as test-only

2. **`layerCount` property** - Only used in tests, never in production code
   - Definition: `src/renderer/hooks/useLayerStack.ts:298`
   - All usages are in test files
   - Could use `hasOpenLayers()` or `layers.length` directly if needed in production

## Deprecated Patterns

None found.

The file uses modern React patterns:
- Functional components with hooks
- `createContext` with proper null handling
- `useRef` pattern for accessing latest values without stale closures
- Capture phase event listener for Escape key (correct for modal handling)
- Proper cleanup in useEffect

## Duplication

1. **`FocusTrapMode` type inline definition**
   - `src/renderer/hooks/useModalLayer.ts:42` defines `focusTrap?: 'strict' | 'lenient' | 'none'` inline
   - Should import `FocusTrapMode` from `src/renderer/types/layer.ts:20` instead
   - Minor duplication but creates maintenance risk if types diverge

2. **Layer registration pattern repeated across 30+ components**
   - Pattern: `registerLayer`, `unregisterLayer`, `updateLayerHandler` with `layerIdRef`
   - Already addressed by `useModalLayer.ts` hook, but many components still use direct API
   - Components like `AutoRunLightbox.tsx`, `FilePreview.tsx`, `GitDiffViewer.tsx` could migrate to `useModalLayer`

## Code Smells

None found.

The file is exemplary:
- 95 lines - well under the 300-line guideline
- Single responsibility: provides context and handles global Escape
- Clean separation from hook implementation
- Excellent documentation with JSDoc and usage examples
- Proper error handling with descriptive error message

## Type Safety Issues

None found.

The file has excellent type safety:
- Strongly typed context with `LayerStackAPI | null`
- Proper null check with descriptive error
- No `any` types
- Clean interface import from hook module

## Recommended Refactoring

1. **Remove or document `getLayers()` as test-only** (Low)
   - No production code uses this API
   - Either remove from public interface or add JSDoc noting it's for testing/debugging

2. **Remove or document `layerCount` as test-only** (Low)
   - Same as above - only test usages
   - Consider removing in favor of `hasOpenLayers()` boolean check

3. **Import `FocusTrapMode` type in useModalLayer.ts** (Low)
   - Change `focusTrap?: 'strict' | 'lenient' | 'none'` to `focusTrap?: FocusTrapMode`
   - Add import: `import type { FocusTrapMode } from '../types/layer'`

4. **Migrate remaining components to useModalLayer hook** (Low)
   - Many modal/overlay components still use direct layer stack API
   - Could reduce boilerplate by migrating to `useModalLayer` abstraction
   - Low priority as current pattern works correctly

5. **Consider consolidating type exports** (Low)
   - `LayerStackAPI` is exported from both `hooks/useLayerStack.ts` and used via context
   - Could re-export from context for single import source

## Estimated Impact

**Risk Level: Very Low**

- All changes are additive/cleanup - no behavioral changes
- Excellent existing test coverage (800+ lines across context and hook tests)
- File is already well-designed with minimal issues
- Most recommendations are polish items

**Testing Considerations:**
- Existing tests in `LayerStackContext.test.tsx` cover core functionality
- Existing tests in `useLayerStack.test.ts` cover hook implementation
- Removing `getLayers`/`layerCount` would require test updates but no production impact
