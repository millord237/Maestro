# Refactor Task 49: group-chat-router.ts

## Summary
The group-chat-router.ts file (723 lines) is well-structured with good test coverage (300+ line test file). Key findings include significant code duplication in auto-add participant logic (repeated twice), history context building (repeated 3 times), custom args parsing (duplicated with process.ts), and the fallback CWD pattern (repeated 7 times across group-chat files). The file has minimal dead code and good type safety overall.

## Dead Code
- **`normalizeMentionName()` function (lines 19-21)** - Only used internally by `mentionMatchesName()`, could be inlined. Not exposed externally.
- **`_processManager` parameter in `routeAgentResponse` (line 566)** - Prefixed with underscore indicating intentionally unused. Kept for API consistency with other routing functions but never utilized in the function body. Consider removing if not needed for future use.

## Deprecated Patterns
None found. The file uses modern async/await patterns, module-level callbacks for dependency injection, and proper event emitter patterns.

## Duplication

### 1. Auto-Add Participant Logic (High Priority)
**Lines 211-258 (user message) and 405-450 (moderator response)** - Nearly identical ~45-line blocks that:
- Extract mentions
- Find matching sessions
- Check if already a participant
- Call `addParticipant()`
- Emit participants changed event
- Handle errors

**Recommendation:** Extract to a shared helper function `autoAddMentionedParticipants(groupChatId, mentions, existingNames, processManager, agentDetector)`.

### 2. History Context Building (Medium Priority)
**Lines 327-330, 471-474, 690-693** - Three instances of similar pattern:
```typescript
const historyContext = chatHistory.slice(-N).map(m =>
  `[${m.from}]: ${m.content}`
).join('\n');
```
With N = 20, 15, or 30, and some with content truncation.

**Recommendation:** Extract to `buildHistoryContext(chatHistory, limit, truncateAt?)` helper.

### 3. Custom Args Parsing (Medium Priority)
**Lines 299-305 and 681-686** - Identical regex parsing for custom args:
```typescript
const customArgsStr = chat.moderatorConfig.customArgs.trim();
if (customArgsStr) {
  const customArgsArray = customArgsStr.match(/(?:[^\s"']+|"[^"]*"|'[^']*')+/g) || [];
  args.push(...customArgsArray.map(arg => arg.replace(/^["']|["']$/g, '')));
}
```
Also duplicated in `src/main/ipc/handlers/process.ts:212`.

**Recommendation:** Extract to shared utility `parseCustomArgs(customArgsStr: string): string[]`.

### 4. Fallback CWD Pattern (Low Priority)
**Lines 348, 488, 712** - `process.env.HOME || '/tmp'` pattern repeated. Also appears 7 times across group-chat files total.

**Recommendation:** Extract to constant `const DEFAULT_CWD = process.env.HOME || '/tmp'` in shared group-chat constants.

### 5. SessionInfo Interface (Low Priority)
**Lines 48-53** - `SessionInfo` interface is similar to but not identical with `src/shared/types.ts:SessionInfo`. The group-chat version has `toolType: string` while shared has `toolType: ToolType`.

## Code Smells

### 1. Large Functions
- **`routeUserMessage` (lines 194-364)** - 170 lines, handles multiple responsibilities: auto-adding participants, logging, emitting events, building prompts, spawning moderator.
- **`routeModeratorResponse` (lines 378-549)** - 171 lines, similar sprawl with auto-add logic + participant spawning.

**Recommendation:** Extract helper functions for:
- `autoAddMentionedParticipants()`
- `spawnModeratorProcess()`
- `buildModeratorPrompt()`
- `spawnParticipantProcesses()`

### 2. Magic Numbers
- **Line 328:** `-20` for history context in user message routing
- **Line 472:** `-15` for history context in moderator response (also truncates at 500 chars)
- **Line 691:** `-30` for history context in synthesis

**Recommendation:** Extract to named constants like `HISTORY_CONTEXT_USER = 20`, `HISTORY_CONTEXT_PARTICIPANT = 15`, `HISTORY_CONTEXT_SYNTHESIS = 30`.

### 3. Module-Level Mutable State
**Lines 66-69 and 76:** Module-level callbacks (`getSessionsCallback`, `getCustomEnvVarsCallback`) and `pendingParticipantResponses` Map. This is acceptable for dependency injection but makes testing more complex.

## Type Safety Issues

### 1. SessionInfo Interface Mismatch
**Lines 48-53:** Local `SessionInfo` defines `toolType: string` but should use `ToolType` from shared/types.ts for consistency:
```typescript
// Current
toolType: string;

// Should be
toolType: ToolType;
```

### 2. IProcessManager Import Inconsistency
**Lines 32-36:** Imports `IProcessManager` from `group-chat-moderator.ts`, but that file's interface lacks some fields used elsewhere (like `customEnvVars` in the spawn config object). The interface is consistent within group-chat but differs slightly from `GenericProcessManager` in `groupChat.ts`.

### 3. Error Parameter Typing
**Lines 253-256, 445-448, 535-538, 609-611, 628-630, 719-721:** Catch blocks have implicit `any` error type. TypeScript 4.4+ allows `catch (error: unknown)` for safer error handling.

## Recommended Refactoring

1. **Extract Auto-Add Participant Helper (High Priority)**
   - Create `autoAddMentionedParticipants()` to deduplicate lines 211-258 and 405-450
   - Reduces code by ~40 lines and eliminates maintenance burden

2. **Extract Custom Args Parser (Medium Priority)**
   - Move regex parsing to `src/shared/stringUtils.ts` or `src/main/utils/parseArgs.ts`
   - Share with `process.ts` and other consumers

3. **Extract History Context Builder (Medium Priority)**
   - Create `buildHistoryContext(chatHistory, limit, truncateAt?)` helper
   - Reduces duplication and makes limits configurable

4. **Create Group Chat Constants (Low Priority)**
   - Extract magic numbers for history limits
   - Extract `DEFAULT_CWD` constant
   - Place in `src/main/group-chat/constants.ts`

5. **Fix SessionInfo Type (Low Priority)**
   - Change `toolType: string` to `toolType: ToolType`
   - Import `ToolType` from shared/types.ts

6. **Break Up Large Functions (Low Priority)**
   - Extract `spawnModeratorProcess()` helper
   - Extract `spawnParticipantProcesses()` helper
   - Improve readability and testability

7. **Type Error Parameters (Low Priority)**
   - Add explicit `catch (error: unknown)` and type guards
   - Improves type safety in error handling

## Estimated Impact
- **Risk Level:** Low to Medium
- **Testing Considerations:**
  - Excellent test coverage exists (300+ line test file)
  - Helper extraction is safe refactoring
  - Type changes may require test updates
  - Shared utility extraction requires integration testing
- **Dependencies:** Changes to `SessionInfo` would need coordination with shared/types.ts. Custom args parser extraction would benefit multiple files.
