# Refactor Task 37: src/main/utils/terminalFilter.ts

## Summary
The terminal filter utility is a well-structured 176-line file with excellent test coverage (459-line test file). Two exported functions (`isCommandEcho` and `extractCommand`) are dead code in production. There is moderate duplication with `src/shared/stringUtils.ts` for ANSI stripping functionality. The regex patterns are complex but well-documented and tested.

## Dead Code
- **`isCommandEcho()` function** (lines 153-166): Exported but only used in test file, never called in production code
- **`extractCommand()` function** (lines 171-175): Exported but only used in test file, never called in production code
- **`stripAllAnsiCodes()` function** (lines 135-147): Exported but lacks test coverage (not tested in terminalFilter.test.ts)

## Deprecated Patterns
None found. The file uses modern ES6+ patterns, proper TypeScript typing, and clean functional design.

## Duplication
- **ANSI code stripping** duplicated with `src/shared/stringUtils.ts`:
  - `terminalFilter.ts:stripAllAnsiCodes()` - more comprehensive (handles OSC, character sets, control chars)
  - `stringUtils.ts:stripAnsiCodes()` - simpler, only handles CSI sequences
  - Used in different contexts: terminalFilter for main process, stringUtils for web/mobile
  - Could be consolidated with the more comprehensive version exported from shared

## Code Smells
- **Complex regex patterns** (6 regexes in `stripControlSequences`, 6 in `stripAllAnsiCodes`): While well-documented and tested, these are difficult to maintain. Consider extracting named patterns as constants.
- **Magic characters** (`\x1b`, `\x07`, `\u00AD`) used directly without named constants

## Type Safety Issues
None found. All functions have proper TypeScript annotations:
- Parameters properly typed with optional markers where appropriate
- Return types are explicit (`string`, `boolean`)
- No `any` types or unsafe casts

## Recommended Refactoring

1. **Remove dead code `isCommandEcho` and `extractCommand`** (Low priority)
   - These functions are only tested but never used in production
   - Either remove them or document their intended use case for future features
   - If they're for potential future use, mark them with a `@internal` JSDoc tag

2. **Add test coverage for `stripAllAnsiCodes`** (Medium priority)
   - Function is used in production (process-manager.ts line 685) but has no tests
   - Add tests similar to `stripControlSequences` tests

3. **Consolidate ANSI stripping with shared/stringUtils.ts** (Low priority)
   - Decide on single source of truth for ANSI code stripping
   - Option A: Move `stripAllAnsiCodes` to shared and deprecate `stringUtils.stripAnsiCodes`
   - Option B: Keep both with clear documentation on when to use each
   - Rationale: `stripAllAnsiCodes` is more comprehensive but the simpler version may be sufficient for web/mobile

4. **Extract regex patterns to named constants** (Low priority)
   - Create `CONTROL_SEQUENCE_PATTERNS` object with named regexes
   - Improves maintainability and self-documentation
   - Example: `OSC_SEQUENCE`, `CSI_NON_COLOR`, `SHELL_INTEGRATION_133`, etc.

5. **Add named constants for magic characters** (Low priority)
   - `ESC = '\x1b'`, `BEL = '\x07'`, `SOFT_HYPHEN = '\u00AD'`
   - Improves readability

## Estimated Impact
- **Risk Level:** Low
- All changes are safe refactoring (removing unused exports, adding tests, consolidating)
- The file has excellent 459-line test coverage for core functionality
- `stripAllAnsiCodes` is the only gap - used in production but untested
- No breaking changes expected if dead code is removed (only test file uses it)
