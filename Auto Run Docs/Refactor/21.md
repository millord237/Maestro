# Refactor Task 21: src/main/ipc/handlers/playbooks.ts

## Summary

The file is well-structured at 387 lines with good use of the `createIpcHandler` utility for consistent error handling. However, there are several issues: significant type duplication with the CLI services, unused dependencies, missing type definitions in preload.ts, and duplicated read/write logic between main and CLI processes.

## Dead Code

- **Line 24: `mainWindow` in `PlaybooksHandlerDependencies`** - The `mainWindow` property is declared in the interface but never accessed directly. Only `getMainWindow()` is used (lines 232, 306). The property can be removed from the interface.

## Deprecated Patterns

- None found. The file uses modern async/await patterns and the `createIpcHandler` utility for consistent IPC handling.

## Duplication

1. **Playbook read/write logic duplicated with CLI** (`src/main/ipc/handlers/playbooks.ts:32-64` vs `src/cli/services/playbooks.ts:17-44`)
   - `getPlaybooksFilePath()` - nearly identical logic in both files
   - `readPlaybooks()` - nearly identical logic (main uses async fs, CLI uses sync fs)
   - `writePlaybooks()` only exists in main, but could be shared
   - **Recommendation**: Extract shared playbook file operations to `src/shared/playbook-storage.ts` and have both main and CLI import from there.

2. **Playbook type defined inline 3 times** (lines 113-126, 159-170, handler parameters)
   - The `newPlaybook` object type is defined inline in `playbooks:create` handler
   - The `updates` parameter type is defined inline in `playbooks:update` handler
   - Should import `Playbook` and `PlaybookDocumentEntry` from `src/shared/types.ts`

3. **Playbook types duplicated across files**:
   - `src/shared/types.ts:62-82` - Canonical definition
   - `src/renderer/types/index.ts:185-210` - Duplicate definition (not re-exporting from shared)
   - `src/main/preload.ts:1642-1702` - Inline type definitions (3 repetitions)
   - Handler file uses inline types instead of importing

4. **Document array type repeated** (lines 99, 118, 161)
   - `documents: any[]` pattern repeated with varying inline types
   - Should use `PlaybookDocumentEntry[]` from shared types

## Code Smells

1. **Weak typing with `any[]`** (lines 40, 55)
   - `readPlaybooks()` returns `Promise<any[]>` instead of `Promise<Playbook[]>`
   - `writePlaybooks()` accepts `playbooks: any[]` instead of `Playbook[]`
   - Makes type-unsafe operations possible without compile-time errors

2. **Missing `export`/`import` handlers in MaestroAPI type** (`preload.ts:1642-1703`)
   - The `playbooks:export` and `playbooks:import` handlers are exposed via `ipcRenderer.invoke` (lines 887-890) but NOT in the `MaestroAPI` interface type definition
   - This means TypeScript doesn't validate calls to `window.maestro.playbooks.export()` or `window.maestro.playbooks.import()`

3. **Type mismatch: `maxLoops` field missing in preload.ts types**
   - Handler at line 271 includes `maxLoops: playbook.maxLoops` in export
   - Handler at line 371 includes `maxLoops: manifest.maxLoops` in import
   - But preload.ts type definitions (lines 1645-1654, 1666-1674) don't include `maxLoops`
   - This causes the field to be silently dropped from TypeScript types

4. **Type mismatch: `worktreeSettings` inconsistent**
   - Handler includes `worktreeSettings.prTargetBranch` (lines 103-106, 122-125, 165-169)
   - preload.ts types at lines 865-868 and 879-882 are missing `prTargetBranch` property
   - This causes type checking to miss the optional field

5. **Silent error swallowing in catch block** (lines 46-49)
   - `readPlaybooks()` catches all errors and returns empty array
   - No differentiation between "file not found" (expected) and other errors (unexpected)
   - CLI version at `src/cli/services/playbooks.ts:39-44` properly checks for `ENOENT`

6. **Error handling inconsistency** (lines 286-289)
   - Document read failure during export only logs warning but continues
   - Should consider failing the entire export or at least reporting missing docs to user

## Type Safety Issues

1. **`any` types in function signatures** (5 instances):
   - Line 40: `Promise<any[]>` return type for `readPlaybooks`
   - Line 55: `playbooks: any[]` parameter for `writePlaybooks`
   - Line 99: `documents: any[]` in create handler parameter
   - Line 161: `documents: any[]` in update handler parameter
   - Line 175: `(p: any)` in findIndex callback
   - Line 203: `(p: any)` in findIndex callback
   - Line 226: `(p: any)` in find callback

2. **Missing return types in function declarations**:
   - Line 32: `getPlaybooksFilePath` - has implicit return type, should be explicit `: string`

3. **Inline type definitions instead of imports**:
   - Lines 96-107: Create handler playbook parameter type defined inline
   - Lines 113-126: `newPlaybook` type defined inline
   - Lines 159-170: Update handler updates parameter type defined inline
   - All should import from `src/shared/types.ts`

## Recommended Refactoring

1. **[High] Fix preload.ts type definitions**
   - Add `export` and `import` methods to `MaestroAPI.playbooks` type
   - Add `maxLoops` field to all Playbook type definitions
   - Add `prTargetBranch` to `worktreeSettings` type
   - Priority: High - causes TypeScript to miss type errors

2. **[High] Replace `any` types with proper Playbook types**
   - Import `Playbook`, `PlaybookDocumentEntry` from `src/shared/types.ts`
   - Change `readPlaybooks` return type to `Promise<Playbook[]>`
   - Change `writePlaybooks` parameter to `Playbook[]`
   - Priority: High - improves type safety significantly

3. **[Medium] Remove unused `mainWindow` from dependencies**
   - Remove from `PlaybooksHandlerDependencies` interface
   - Only `getMainWindow` is actually used
   - Priority: Medium - removes dead code

4. **[Medium] Consolidate Playbook type definitions**
   - Have `src/renderer/types/index.ts` re-export from `src/shared/types.ts`
   - Have `preload.ts` import from shared types
   - Remove inline type definitions in handlers
   - Priority: Medium - reduces duplication significantly

5. **[Medium] Extract shared playbook storage to shared module**
   - Create `src/shared/playbook-storage.ts` with file path and read logic
   - Have both main and CLI import shared functions
   - Priority: Medium - eliminates code duplication

6. **[Low] Improve error handling in readPlaybooks**
   - Check for specific error codes like CLI version does
   - Log unexpected errors before returning empty array
   - Priority: Low - defensive improvement

7. **[Low] Add validation for playbook manifest on import**
   - Validate manifest has required fields
   - Validate document entries have correct structure
   - Priority: Low - improves robustness

## Estimated Impact

**Risk Level: Low to Medium**
- Type fixes in preload.ts are safe additions
- Replacing `any` types could surface existing type errors that need fixing
- Consolidating type definitions requires coordinated changes across files

**Testing Considerations:**
- Export/import functionality should be manually tested after preload.ts type fixes
- Unit tests exist for CLI playbook operations (`src/__tests__/cli/services/playbooks.test.ts`)
- No direct unit tests exist for the main process handlers - consider adding
- Integration tests needed for playbook CRUD operations
