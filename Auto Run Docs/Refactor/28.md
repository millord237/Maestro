# Refactor Task 28: src/main/parsers/error-patterns.ts

## Summary

Error detection patterns module that is well-structured (486 lines) with good test coverage. Main findings: `registerErrorPatterns` function is only used in tests (dead code candidate), significant duplication of `detectErrorFromLine` and `detectErrorFromExit` logic across all 3 parser implementations (~80 lines each), similar error patterns across agents that could be consolidated into a base set, and hardcoded `AgentErrorType` array that could become stale if types.ts is updated.

## Dead Code

- **`registerErrorPatterns()` function (lines 473-478):** Exported but only used in tests for teardown/reset. Never called in production code. The pattern registry is initialized statically via `patternRegistry = new Map<ToolType, AgentErrorPatterns>([...])` at module load time (lines 415-419).

- **`clearPatternRegistry()` function (lines 483-485):** Only used in tests for isolation. Never called in production code.

Both functions are intentionally for testing infrastructure, not production dead code - but this should be documented.

## Deprecated Patterns

None found.

## Duplication

1. **`detectErrorFromLine` implementation duplicated across 3 parsers (~80 lines each):**
   - `claude-output-parser.ts:240-287` (47 lines)
   - `opencode-output-parser.ts:301-387` (86 lines, more complex due to nested error structure)
   - `codex-output-parser.ts:435-485` (50 lines)

   All three follow the same structure:
   - Skip empty lines
   - Try to parse JSON
   - Extract error text from structured error events
   - Call `matchErrorPattern()` with agent-specific patterns
   - Return AgentError or null

2. **`detectErrorFromExit` implementation duplicated across 3 parsers (~45 lines each):**
   - `claude-output-parser.ts:292-336`
   - `opencode-output-parser.ts:392-436`
   - `codex-output-parser.ts:490-534`

   All three are nearly identical:
   - Check exitCode === 0 (return null)
   - Combine stderr + stdout
   - Match against patterns
   - Return crash error if no pattern matched

3. **Similar patterns across agent definitions:**
   - `CLAUDE_ERROR_PATTERNS`, `OPENCODE_ERROR_PATTERNS`, `CODEX_ERROR_PATTERNS` share ~70% of their patterns
   - Network error patterns are nearly identical across all three (lines 139-165, 253-275, 366-387)
   - Connection patterns `/connection\s*(failed|refused|error|reset|closed)/i` appear in all three
   - `ECONNREFUSED|ECONNRESET|ETIMEDOUT|ENOTFOUND` pattern is identical in all three

4. **Hardcoded error type array (line 441-448) duplicates AgentErrorType:**
   ```typescript
   const errorTypes: AgentErrorType[] = [
     'auth_expired',
     'token_exhaustion',
     'rate_limited',
     'network_error',
     'permission_denied',
     'agent_crashed',
   ];
   ```
   This duplicates the type definition in `shared/types.ts:132-139` and will become stale if types are added/removed.

## Code Smells

1. **`matchErrorPattern` iterates through hardcoded error type array (lines 441-448):**
   The function manually lists all error types instead of deriving them from the `AgentErrorType` type. If a new error type is added to `shared/types.ts`, this array must be manually updated.

2. **Regex pattern `/529/i` too broad (line 123):**
   Will match any line containing "529" including port numbers, version strings, etc. Should be more specific like `/\b529\b/` or `/error.*529|529.*error/i`.

3. **Regex pattern `/429/i` too broad (line 360):**
   Same issue - will match any "429" substring. Should use word boundary or context.

4. **Missing 'unknown' error type in patterns:**
   The `AgentErrorType` includes `'unknown'` but no patterns map to it. The `unknown` type is used as a fallback in OpenCode parser (line 374-384) but never matched via patterns.

5. **No validation that pattern registry covers all ToolTypes:**
   Only 3 agents are registered (claude-code, opencode, codex) but `ToolType` may include more. Unknown agents silently return empty patterns via `getErrorPatterns()`.

## Type Safety Issues

1. **Unsafe cast in `getErrorPatterns` (line 427):**
   ```typescript
   return patternRegistry.get(agentId as ToolType) || {};
   ```
   The function accepts `ToolType | string` but casts to `ToolType` without validation. A typo like `'claude'` instead of `'claude-code'` would silently return empty patterns.

2. **Missing return type annotation on hardcoded array (lines 441-448):**
   The `errorTypes` array is correctly typed as `AgentErrorType[]`, but if the loop logic changes, there's no compile-time guarantee that all types are checked.

## Recommended Refactoring

1. **[Medium Priority] Extract base error detection logic to abstract base class:**
   Create a `BaseOutputParser` class with default implementations of `detectErrorFromLine` and `detectErrorFromExit` that parsers can override. This eliminates ~180 lines of duplication.

2. **[Medium Priority] Create shared base patterns constant:**
   ```typescript
   const BASE_ERROR_PATTERNS: AgentErrorPatterns = {
     network_error: [...commonNetworkPatterns],
     // etc.
   };
   ```
   Agent-specific patterns can merge with or override base patterns.

3. **[Low Priority] Derive error type iteration from type system:**
   Use a const object pattern to derive the error types array:
   ```typescript
   const ERROR_TYPES = ['auth_expired', 'token_exhaustion', ...] as const;
   type AgentErrorType = typeof ERROR_TYPES[number];
   ```
   Then use `ERROR_TYPES` in `matchErrorPattern`.

4. **[Low Priority] Add word boundaries to HTTP status code patterns:**
   Change `/529/i` to `/\b529\b/` and `/429/i` to `/\b429\b/` to prevent false positives.

5. **[Low Priority] Document test-only exports:**
   Add JSDoc comments to `registerErrorPatterns` and `clearPatternRegistry` indicating they are for testing only:
   ```typescript
   /**
    * Register error patterns for an agent.
    * @internal Used only for testing - patterns are registered statically at module load.
    */
   ```

6. **[Low Priority] Add ToolType validation to getErrorPatterns:**
   Log a warning when an unknown agent ID is passed, helping catch typos during development.

7. **[Low Priority] Consider exhaustiveness check for error types:**
   The pattern matching could use TypeScript's exhaustiveness checking to ensure all error types are covered.

## Estimated Impact

**Risk Level:** Low - This is a utility module with excellent test coverage (575-line test file). Changes to pattern matching or base class extraction should be well-covered by existing tests.

**Testing Considerations:**
- Existing test file covers all major functionality
- Changes to patterns should verify no false positives are introduced
- Base class extraction would require updating all parser tests
- HTTP status code pattern changes should be tested with realistic error messages
