# Refactor Task 19: src/main/ipc/handlers/history.ts

## Summary

The history IPC handlers file is well-structured at 229 lines with clean delegation to the `HistoryManager` class. Key issues include significant duplication with CLI storage service (6+ shared methods reimplemented), inline type definitions in preload.ts instead of importing from shared/types.ts, and a legacy compatibility handler (`history:reload`) that is a no-op but still exposed.

## Dead Code

1. **`history:reload` handler is a no-op** (lines 95-101)
   - The handler logs "no-op for per-session storage" and returns `true`
   - Kept for API compatibility but does nothing
   - Called from renderer in `useWebBroadcasting.ts:47` and `useFileTreeManagement.ts:146`
   - Should be deprecated with clear migration path

## Deprecated Patterns

1. **`history:getAll` marked as legacy** (lines 46-67)
   - Comment explicitly states "Legacy handler - returns all entries (use history:getAllPaginated for large datasets)"
   - Still actively used in `HistoryPanel.tsx:458`
   - Should add deprecation warning in the JSDoc

2. **Deprecated methods in HistoryManager still used** (history-manager.ts:323-335, 357-370)
   - `getAllEntries()` and `getEntriesByProjectPath()` are marked `@deprecated`
   - The `history:getAll` handler calls these deprecated methods
   - Should transition fully to paginated APIs

## Duplication

1. **Major duplication with `src/cli/services/storage.ts`** (lines 90-439)
   - **6+ methods reimplemented** with nearly identical logic:
     - `hasMigrated()` - checks for migration marker file (storage.ts:97-100)
     - `getHistoryDir()` - returns history directory path (storage.ts:105-107)
     - `getSessionHistoryPath()` / `getSessionFilePath()` - sanitizes and builds file path (storage.ts:112-115)
     - `readSessionHistory()` / `getEntries()` - reads and parses session JSON (storage.ts:120-131)
     - `listSessionsWithHistory()` - lists JSON files in history dir (storage.ts:136-145)
     - `addHistoryEntry()` / `addEntry()` - writes entry to session file (storage.ts:375-439)
   - Both files import from `shared/history.ts` for common utilities but reimplement file operations
   - **Solution**: Create a shared `HistoryStorageBase` class in shared/ that both can extend

2. **HistoryEntry type defined inline in preload.ts** (preload.ts:729-751, 1488-1510)
   - Same type structure defined 3 times:
     - `shared/types.ts:44-59` - canonical definition
     - `preload.ts:729-751` - inline in implementation
     - `preload.ts:1488-1543` - inline in MaestroAPI interface
   - Should import from shared/types.ts instead

3. **Session iteration pattern duplicated** (lines 153-163, 184-190)
   - "Search all sessions for the entry" pattern repeated in `history:delete` and `history:update`
   - Could be extracted to a helper: `findEntryAcrossSessions(entryId, operation)`

## Code Smells

1. **External change event missing sessionId in renderer handler** (preload.ts:768-772)
   - The main process sends `sessionId` with the event (index.ts:698)
   - But the preload handler signature is `(handler: () => void)` - ignores the sessionId
   - MaestroAPI type signature is `onExternalChange: (handler: () => void) => () => void`
   - This forces inefficient full reload instead of targeted session refresh

2. **Inconsistent clear handler** (lines 114-135)
   - `history:clear` accepts `(projectPath?, sessionId?)` but:
     - Implementation checks sessionId first, then projectPath
     - Preload.ts type signature only shows `clear: (projectPath?: string)` - missing sessionId option
   - Type mismatch between handler and exposed API

## Type Safety Issues

1. **Inline type definitions instead of imports** (preload.ts)
   - `HistoryEntry` structure inlined ~3 times in preload.ts:
     - Lines 729-751 (add entry parameter)
     - Lines 1488-1510 (getAll return type)
     - Lines 1516-1538 (getAllPaginated return type)
   - Should import from `shared/types.ts`

2. **Pagination options not typed from shared** (preload.ts:727-728)
   - Uses `{ limit?: number; offset?: number }` inline
   - Should use `PaginationOptions` from `shared/history.ts`

3. **PaginatedResult not typed from shared** (preload.ts:1515-1543)
   - Return type for getAllPaginated uses inline object type
   - Should use `PaginatedResult<HistoryEntry>` from `shared/history.ts`

4. **Missing type for updates parameter** (preload.ts:1569)
   - `updates: { validated?: boolean }` is too narrow
   - Actual handler uses `Partial<HistoryEntry>` (line 172)
   - Type mismatch between declaration and implementation

## Recommended Refactoring

1. **High: Extract shared history storage base class**
   - Create `src/shared/history-storage.ts` with file operations
   - Both `HistoryManager` (main) and `storage.ts` (CLI) extend it
   - Eliminates ~100 lines of duplication
   - Ensures consistent behavior across Electron and CLI

2. **High: Import types from shared instead of inline**
   - Remove all inline HistoryEntry definitions in preload.ts
   - Import from `shared/types.ts` and `shared/history.ts`
   - Reduces 150+ lines of duplicate type code
   - Single source of truth for types

3. **Medium: Fix onExternalChange handler signature**
   - Change to `(handler: (sessionId: string) => void)`
   - Update renderer handlers to use sessionId for targeted refresh
   - Improves performance by avoiding full history reload

4. **Medium: Fix history:clear type mismatch**
   - Update preload.ts type to include sessionId parameter
   - `clear: (projectPath?: string, sessionId?: string) => Promise<boolean>`

5. **Low: Deprecate history:reload properly**
   - Add @deprecated JSDoc with migration guide
   - Consider removing in future major version
   - Update renderer code to not call it

6. **Low: Extract findEntryAcrossSessions helper**
   - Reduce duplication in delete/update handlers
   - Single pattern for searching all sessions

7. **Low: Add deprecation warning to history:getAll**
   - Add JSDoc @deprecated pointing to getAllPaginated
   - Log warning in development mode when used

## Estimated Impact

**Risk Level: Low**
- Changes are mostly additive (shared base class) or type improvements
- No behavioral changes required
- Existing API surface remains stable

**Testing Considerations:**
- Unit tests for new shared history storage base class
- Verify CLI and Electron behavior remains identical
- Test external change event handler with sessionId
- Verify type changes don't break renderer usage

**Migration Path:**
1. Create shared base class first (no breaking changes)
2. Update HistoryManager and storage.ts to extend it
3. Update preload.ts types to import from shared
4. Fix onExternalChange signature with fallback
5. Add deprecation warnings to legacy methods
